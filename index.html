<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>EPS & Price Chart</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  margin: 10px;
  font-family: sans-serif;
}

/* グラフを画面幅にフィット */
canvas {
  width: 100% !important;
  height: auto !important;
  max-height: 200px;
}

/* 横スクロール対応表 */
#epsTableContainer {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  margin-top: 10px;
}

table {
  border-collapse: collapse;
  font-size: 14px; /* モバイルでも見やすい文字サイズ */
  table-layout: auto;
  min-width: max-content; /* 縮小させず横スクロール */
}

th, td {
  border: 1px solid #999;
  padding: 6px 8px;
  text-align: right;
  white-space: nowrap;
}

th {
  background: #f0f0f0;
  position: sticky;
  top: 0;
  z-index: 1;
}

td.symbol-cell {
  text-align: left;
  cursor: pointer;
  color: blue;
  text-decoration: underline;
}

#searchBox {
  margin-top: 15px;
  margin-bottom: 5px;
  padding: 6px;
  width: 100%;
  max-width: 300px;
  font-size: 14px;
}

h2 {
  font-size: 18px;
  margin-bottom: 8px;
}

/* モバイル微調整 */
@media (max-width: 600px) {
  table { font-size: 14px; }
  th, td { padding: 5px 6px; }
  #searchBox { font-size: 14px; padding: 6px; }
  h2 { font-size: 16px; }
}
</style>
</head>
<body>
<h2>EPS & Price Chart</h2>

<canvas id="epsPriceChart"></canvas>

<input type="text" id="searchBox" placeholder="銘柄検索...">

<div id="epsTableContainer"></div>

<script>
const files = { eps: "epstrend.csv", price: "price.csv", calendar: "calendar.csv" };
let dataAll = { eps: {}, price: {}, calendar: {} };
let dateLabels = [];
let calendarHeader = [];

function loadCSV(url) {
    return fetch(url).then(res => res.text())
        .then(text => {
            const rows = text.trim().split("\n").map(r => r.split(","));
            const header = rows[0].slice(1);
            const data = {};
            rows.slice(1).forEach(row => {
                const symbol = row[0];
                data[symbol] = row.slice(1).map(v => v === "" ? null : v);
            });
            return { header, data };
        });
}

function loadCalendarCSV(url) {
    return fetch(url).then(res => res.text())
        .then(text => {
            const rows = text.trim().split("\n").map(r => r.split(","));
            calendarHeader = rows[0].slice(1);
            const data = {};
            rows.slice(1).forEach(row => {
                const symbol = row[0];
                data[symbol] = row.slice(1);
            });
            return data;
        });
}

Promise.all([loadCSV(files.eps), loadCSV(files.price), loadCalendarCSV(files.calendar)])
.then(([epsData, priceData, calendarData]) => {
    dateLabels = epsData.header;
    dataAll.eps = epsData.data;
    dataAll.price = priceData.data;
    dataAll.calendar = calendarData;

    const firstSymbol = Object.keys(dataAll.eps)[0];
    updateChart(firstSymbol);
    createEpsTable();
});

let epsPriceChart;

function updateChart(symbol) {
    if (epsPriceChart) epsPriceChart.destroy();

    epsPriceChart = new Chart(document.getElementById("epsPriceChart"), {
        type: "line",
        data: {
            labels: dateLabels,
            datasets: [
                { label: `EPS (${symbol})`, data: dataAll.eps[symbol].map(v => parseFloat(v)), borderColor: "blue", fill: false, yAxisID: 'y1' },
                { label: `Price (${symbol})`, data: dataAll.price[symbol].map(v => parseFloat(v)), borderColor: "green", fill: false, yAxisID: 'y2' }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y1: { type: 'linear', position: 'left', title: { display: true, text: 'EPS' } },
                y2: { type: 'linear', position: 'right', title: { display: true, text: 'Price' }, grid: { drawOnChartArea: false } }
            },
            plugins: {
                legend: { labels: { font: { size: 12 } } }
            }
        }
    });
}

function createEpsTable() {
    const container = document.getElementById("epsTableContainer");
    container.innerHTML = "";

    const table = document.createElement("table");
    const thead = document.createElement("thead");
    const tbody = document.createElement("tbody");

    const headerRow = document.createElement("tr");
    const thSymbol = document.createElement("th");
    thSymbol.textContent = "Symbol";
    headerRow.appendChild(thSymbol);

    calendarHeader.forEach(colName => {
        const th = document.createElement("th");
        th.textContent = colName;
        headerRow.appendChild(th);
    });

    dateLabels.slice().reverse().forEach(date => {
        const th = document.createElement("th");
        th.textContent = date;
        headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);

    Object.keys(dataAll.eps).forEach(symbol => {
        const row = document.createElement("tr");

        const tdSymbol = document.createElement("td");
        tdSymbol.textContent = symbol;
        tdSymbol.classList.add("symbol-cell");
        tdSymbol.addEventListener("click", () => updateChart(symbol));
        row.appendChild(tdSymbol);

        if (dataAll.calendar[symbol]) {
            dataAll.calendar[symbol].forEach(val => {
                const td = document.createElement("td");
                td.textContent = val || "";
                td.style.textAlign = "center";
                row.appendChild(td);
            });
        } else {
            calendarHeader.forEach(() => {
                const td = document.createElement("td");
                td.textContent = "";
                row.appendChild(td);
            });
        }

        [...dataAll.eps[symbol]].reverse().forEach(val => {
            const td = document.createElement("td");
            td.textContent = val !== null && !isNaN(val) ? parseFloat(val).toFixed(2) : "";
            row.appendChild(td);
        });

        tbody.appendChild(row);
    });

    table.appendChild(thead);
    table.appendChild(tbody);
    container.appendChild(table);

    const searchBox = document.getElementById("searchBox");
    searchBox.addEventListener("input", () => {
        const keyword = searchBox.value.toLowerCase();
        Array.from(tbody.getElementsByTagName("tr")).forEach(tr => {
            const symbol = tr.cells[0].textContent.toLowerCase();
            tr.style.display = symbol.includes(keyword) ? "" : "none";
        });
    });
}
</script>
</body>
</html>